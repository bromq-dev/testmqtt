# 4.3 Quality of Service levels and protocol flows

MQTT delivers Application Messages according to the Quality of Service (QoS) levels defined here. The delivery protocol is symmetric, in the description below the Client and Server can each take the role of either Sender or Receiver. The delivery protocol is concerned solely with the delivery of an application message from a single Sender to a single Receiver. When the Server is delivering an Application Message to more than one Client, each Client is treated independently. The QoS level used to deliver an Application Message outbound to the Client could differ from that of the inbound Application Message.

The non-normative flow diagrams in the following sections are intended to show possible implementation approaches.

### 4.3.1 QoS 0: At most once delivery

The message is delivered according to the capabilities of the underlying network. No response is sent by the receiver and no retry is performed by the sender. The message arrives at the receiver either once or not at all.

In the QoS 0 delivery protocol, the Sender

- MUST send a PUBLISH packet with QoS=0, DUP=0 \[MQTT-4.3.1-1\].

In the QoS 0 delivery protocol, the Receiver

- Accepts ownership of the message when it receives the PUBLISH packet.

##### Figure 4.1 – QoS 0 protocol flow diagram, non normative example

|                      |                    |                                                                |
| -------------------- | ------------------ | -------------------------------------------------------------- |
| **Sender Action**    | **Control Packet** | **Receiver Action**                                            |
| PUBLISH QoS 0, DUP=0 |                    |                                                                |
|                      | \---------->       |                                                                |
|                      |                    | Deliver Application Message to appropriate onward recipient(s) |

### _4.3.2_ _QoS 1: At least once delivery_

This quality of service ensures that the message arrives at the receiver at least once. A QoS 1 PUBLISH Packet has a Packet Identifier in its variable header and is acknowledged by a PUBACK Packet. Section 2.3.1 provides more information about Packet Identifiers.

In the QoS 1 delivery protocol, the Sender

- MUST assign an unused Packet Identifier each time it has a new Application Message to publish.

- MUST send a PUBLISH Packet containing this Packet Identifier with QoS=1, DUP=0.

- MUST treat the PUBLISH Packet as `unacknowledged` until it has received the corresponding PUBACK packet from the receiver. See Section 4.4 for a discussion of unacknowledged messages.

\[MQTT-4.3.2-1\].

The Packet Identifier becomes available for reuse once the Sender has received the PUBACK Packet.

Note that a Sender is permitted to send further PUBLISH Packets with different Packet Identifiers while it is waiting to receive acknowledgements.

In the QoS 1 delivery protocol, the Receiver

- MUST respond with a PUBACK Packet containing the Packet Identifier from the incoming PUBLISH Packet, having accepted ownership of the Application Message
- After it has sent a PUBACK Packet the Receiver MUST treat any incoming PUBLISH packet that contains the same Packet Identifier as being a new publication, irrespective of the setting of its DUP flag.

\[MQTT-4.3.2-2\].

##### Figure 4.2 – QoS 1 protocol flow diagram, non normative example

|                                                     |                    |                                                      |
| --------------------------------------------------- | ------------------ | ---------------------------------------------------- |
| **Sender Action**                                   | **Control Packet** | **Receiver action**                                  |
| Store message                                       |                    |                                                      |
| Send PUBLISH QoS 1, DUP 0, <br> <Packet Identifier> | \---------->       |                                                      |
|                                                     |                    | Initiate onward delivery of the Application Message1 |
|                                                     | <----------        | Send PUBACK <Packet Identifier>                      |
| Discard message                                     |                    |                                                      |

1 The receiver is not required to complete delivery of the Application Message before sending the PUBACK. When its original sender receives the PUBACK packet, ownership of the Application Message is transferred to the receiver.

### 4.3.3 QoS 2: Exactly once delivery

This is the highest quality of service, for use when neither loss nor duplication of messages are acceptable. There is an increased overhead associated with this quality of service.

A QoS 2 message has a Packet Identifier in its variable header. Section 2.3.1 provides more information about Packet Identifiers. The receiver of a QoS 2 PUBLISH Packet acknowledges receipt with a two-step acknowledgement process.

In the QoS 2 delivery protocol, the Sender

- MUST assign an unused Packet Identifier when it has a new Application Message to publish.
- MUST send a PUBLISH packet containing this Packet Identifier with QoS=2, DUP=0.
- MUST treat the PUBLISH packet as `unacknowledged` until it has received the corresponding PUBREC packet from the receiver. See Section 4.4 for a discussion of unacknowledged messages.
- MUST send a PUBREL packet when it receives a PUBREC packet from the receiver. This PUBREL packet MUST contain the same Packet Identifier as the original PUBLISH packet.
- MUST treat the PUBREL packet as `unacknowledged` until it has received the corresponding PUBCOMP packet from the receiver.
- MUST NOT re-send the PUBLISH once it has sent the corresponding PUBREL packet.

\[MQTT-4.3.3-1\].

The Packet Identifier becomes available for reuse once the Sender has received the PUBCOMP Packet.

Note that a Sender is permitted to send further PUBLISH Packets with different Packet Identifiers while it is waiting to receive acknowledgements.

In the QoS 2 delivery protocol, the Receiver

- MUST respond with a PUBREC containing the Packet Identifier from the incoming PUBLISH Packet, having accepted ownership of the Application Message.
- Until it has received the corresponding PUBREL packet, the Receiver MUST acknowledge any subsequent PUBLISH packet with the same Packet Identifier by sending a PUBREC. It MUST NOT cause duplicate messages to be delivered to any onward recipients in this case.
- MUST respond to a PUBREL packet by sending a PUBCOMP packet containing the same Packet Identifier as the PUBREL.
- After it has sent a PUBCOMP, the receiver MUST treat any subsequent PUBLISH packet that contains that Packet Identifier as being a new publication.

\[MQTT-4.3.3-2\].

##### Figure 4.3 – QoS 2 protocol flow diagram, non normative example

|                                                            |                    |                                                                                                                                       |
| ---------------------------------------------------------- | ------------------ | ------------------------------------------------------------------------------------------------------------------------------------- |
| **Sender Action**                                          | **Control Packet** | **Receiver Action**                                                                                                                   |
| Store message                                              |                    |                                                                                                                                       |
| PUBLISH QoS 2, DUP 0 <br> <Packet Identifier>              |                    |                                                                                                                                       |
|                                                            | \---------->       |                                                                                                                                       |
|                                                            |                    | Method A, Store message <br> or <br>Method B, Store <Packet Identifier> then Initiate onward delivery of the Application Message1     |
|                                                            |                    | PUBREC <Packet Identifier>                                                                                                            |
|                                                            | <----------        |                                                                                                                                       |
| Discard message, Store PUBREC received <Packet Identifier> |                    |                                                                                                                                       |
| PUBREL <Packet Identifier>                                 |                    |                                                                                                                                       |
|                                                            | \---------->       |                                                                                                                                       |
|                                                            |                    | Method A, Initiate onward delivery of the Application Message1 then discard message <br> or <br>Method B, Discard <Packet Identifier> |
|                                                            |                    | Send PUBCOMP <Packet Identifier>                                                                                                      |
|                                                            | <----------        |                                                                                                                                       |
| Discard stored state                                       |                    |                                                                                                                                       |

1 The receiver is not required to complete delivery of the Application Message before sending the PUBREC or PUBCOMP. When its original sender receives the PUBREC packet, ownership of the Application Message is transferred to the receiver.

[Figure 4.3](#_Figure_4.3_–) shows that there are two methods by which QoS 2 can be handled by the receiver. They differ in the point within the flow at which the message is made available for onward delivery. The choice of Method A or Method B is implementation specific. As long as an implementation chooses exactly one of these approaches, this does not affect the guarantees of a QoS 2 flow.

